version: '3.8'

services:
  # Kafka Broker (KRaft Mode - No Zookeeper)
  # Two listeners:
  #   PLAINTEXT (9092) — for host-side clients (Spring Boot producer)
  #   INTERNAL  (9094) — for Docker-internal clients (Flink TaskManager)
  kafka:
    image: apache/kafka:latest
    container_name: kafka-broker
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093,INTERNAL://:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,INTERNAL://kafka-broker:9094
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,INTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@localhost:9093
      CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk'

  # Flink JobManager
  jobmanager:
    image: apache/flink:1.20-java17
    container_name: flink-jobmanager
    ports:
      - "8081:8081"
    command: jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager

  # Flink TaskManager
  # Volume mounts /tmp/landing-zone inside the container to ./landing-zone on the host
  # so the Python aws_sync.py script can read the JSONL files produced by the Flink job.
  taskmanager:
    image: apache/flink:1.20-java17
    container_name: flink-taskmanager
    depends_on:
      - jobmanager
    command: taskmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
        taskmanager.numberOfTaskSlots: 2
    volumes:
      - ./landing-zone:/tmp/landing-zone

  # PostgreSQL (Acting as AWS RDS locally)
  # Host port 5433 avoids conflict with Laragon's PostgreSQL on 5432.
  # Flink connects via internal hostname postgres-db:5432.
  postgres:
    image: postgres:16-alpine
    container_name: postgres-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: bank_db
    ports:
      - "5433:5432"

  # LocalStack (Mocking AWS S3 for your Data Lake)
  localstack:
    image: localstack/localstack:latest
    container_name: localstack-aws
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3
      - DEFAULT_REGION=ap-southeast-1 # Malaysia-friendly region
